<?php

// Taxonomy Vocabulary
define('IDW_STAGE_TAXONOMY_MACHINE_NAME', 'workflow_stage_vocab');
define('IDW_CONTENT_TYPE_TAXONOMY_MACHINE_NAME', 'workflow_content_type_vocab');

// Permissions -- NOTE: there are additional permission constants defined in
// islandora_digital_workflow_permission that use the naming convention of
// 'ISLANDORA_DIGITAL_WORKFLOW_' . strtoupper($model_name) - for which a helper
// in includes/access_permissions.inc named
// islandora_digital_workflow_permission_name_of_model() will do.
define('ISLANDORA_DIGITAL_WORKFLOW', 'digital workflow access');
define('ISLANDORA_DIGITAL_WORKFLOW_CREATE_NEW_BATCH', 'digital workflow create batches');

/**
 * Implements hook_menu().
 */
function islandora_digital_workflow_menu() {
  return array(
    'admin/islandora/islandora_digital_workflow' => array(
      'title' => 'Islandora Digital Workflow',
      'description' => 'Settings for the Islandora Digital Workflow module.',
      'type' => MENU_NORMAL_ITEM,
      'page callback' => 'drupal_get_form',
      'page arguments' => array('islandora_digital_workflow_admin_form'),
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/admin.form.inc',
    ),
    'islandora/islandora_digital_workflow' => array(
      'title' => t('Islandora Digital Workflow Dashboard'),
      'type' => MENU_NORMAL_ITEM,
      'page callback' => array('islandora_digital_workflow_dashboard'),
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/dashboard.form.inc',
    ),
    // Lookup form
    'islandora/islandora_digital_workflow/lookup' => array(
      'page callback' => array('islandora_digital_workflow_lookup'),
      'type' => MENU_CALLBACK,
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/lookup.form.inc',
    ),
    // Lookup submit handler - performs search, redirects if finds only one
    // result, else displays the lookup results.
    'islandora/islandora_digital_workflow/lookup/%' => array(
      'title' => t('Islandora Digital Workflow Search'),
      'type' => MENU_CALLBACK,
      'page callback' => array('islandora_digital_workflow_lookup_form_submit'),
      'page arguments' => array(3),
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/lookup.form.inc',
    ),
    'islandora/islandora_digital_workflow/create_batch' => array(
      'title' => t('Islandora Digital Workflow - Create Batch'),
      'type' => MENU_NORMAL_ITEM,
      'page callback' => array('islandora_digital_workflow_create_batch'),
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW_CREATE_NEW_BATCH),
      'file' => 'includes/create_batch.form.inc',
    ),
    'islandora/islandora_digital_workflow/edit_batch/%' => array(
      'title' => t('Islandora Digital Workflow - Edit Batch'),
      'type' => MENU_NORMAL_ITEM,
      'page callback' => array('islandora_digital_workflow_create_batch'),
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/create_batch.form.inc',
    ),
    'islandora/islandora_digital_workflow/delete_batch/%' => array(
      'title' => t('Islandora Digital Workflow - Delete Batch'),
      'type' => MENU_NORMAL_ITEM,
      'page callback' => array('islandora_digital_workflow_delete_batch'),
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/delete_batch.form.inc',
    ),
    // Callback to serve up the dynamically generated CSS file
    'islandora/islandora_digital_workflow_css.css' => array(
      'type' => MENU_CALLBACK,
      'page callback' => 'islandora_digital_workflow_update_dynamic_css',
      'access arguments' => array(ISLANDORA_DIGITAL_WORKFLOW),
      'file' => 'includes/islandora_digital_workflow_css.inc',
    ),
  );
}

/**
 * Implements hook_permission().
 */
function islandora_digital_workflow_permission() {
  module_load_include('inc', 'islandora_digital_workflow', 'includes/utilities');
  module_load_include('inc', 'islandora_digital_workflow', 'includes/access_permissions');
  $static_permissions = array(
    ISLANDORA_DIGITAL_WORKFLOW => array(
      'title' => t('Use the Islandora Digital Workflow system.'),
      'description' => t('User can access and use the Islandora Digital Workflow system.'),
    ),
    ISLANDORA_DIGITAL_WORKFLOW_CREATE_NEW_BATCH => array(
      'title' => t('Create new digital workflow batches.'),
      'description' => t('User can create new batches within the Islandora Digital Workflow system.'),
    ),
  );
  $model_based_permissions = array();
  $models = islandora_digital_workflow_get_reduced_readable_cmodels();

  foreach ($models as $model_name => $readable_model) {
    $permission_define_name = islandora_digital_workflow_permission_constant_name_of_model($model_name);
    $permission = islandora_digital_workflow_permission_of_model($readable_model);
    if (!defined($permission_define_name)) {
      define($permission_define_name, $permission);
    }
    $model_based_permissions[$permission] = array(
      'title' => 'Create/Edit/Update ' . $readable_model . ' batches',
      'description' => 'User can perform tasks related to the ' . $readable_model . ' objects within the Islandora Digital Workflow system',
    );
  }
  return array_merge($static_permissions, $model_based_permissions);
}

/**
 * Implements hook_preprocess_theme().
 *
 * This code will remove the sidebar and must check to see whether or not the path is on a user page.
 */
function islandora_digital_workflow_preprocess_html(&$vars) {
  $path = drupal_get_path('module', 'islandora_digital_workflow');
  $item = menu_get_item();
  if (is_array($item)) {
    $public_files_path = drupal_realpath('public://');
    $base_public_files_path = str_replace(realpath("."), "", $public_files_path);
    // Remove the leading slash.
    $base_public_files_path = substr($base_public_files_path, 1);
    islandora_digital_workflow_ensure_dynamic_css_copied($path, $public_files_path);
    drupal_add_css($path . '/css/islandora_digital_workflow.css');
    drupal_add_css($base_public_files_path . '/islandora_digital_workflow_dynamic.css');
    // Just the admin form needs the /js/admin_form.js added.
    if ($item['path'] == 'admin/islandora/islandora_digital_workflow') {
      drupal_add_js($path . '/js/admin_form.js');
    }
  }
}

function islandora_digital_workflow_ensure_dynamic_css_copied($path, $public_files_path) {
  if (!file_exists($public_files_path . '/islandora_digital_workflow_dynamic.css')) {
    dpm('copy ' . $path . '/css/islandora_digital_workflow_dynamic.css to ' . $public_files_path . '/islandora_digital_workflow_dynamic.css');
    copy($path . '/css/islandora_digital_workflow_dynamic.css', $public_files_path . '/islandora_digital_workflow_dynamic.css');
  }
}

function islandora_digital_workflow_theme() {
  return array(
    'islandora_digital_workflow_dashboard' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/islandora-digital-workflow-dashboard',
      'variables' => array(
        'dashboard_data' => NULL,
        'links' => array(),
      ),
    ),
    'islandora_digital_workflow_batch_defaults' => array(
      'template' => 'theme/islandora-digital-workflow-batch-defaults',
      'variables' => array(
        'islandora_digital_workflow_batch' => NULL,
      ),
    ),
    'islandora_digital_workflow_lookup' => array(
      'template' => 'theme/islandora-digital-workflow-findobject-form',
      'variables' => array(
        'searchterm' => NULL,
      )
    ),
    'islandora_digital_workflow_lookup_results' => array(
      'template' => 'theme/islandora-digital-workflow-lookup-results',
      'variables' => array(
        'batch_records' => array(),
        'results_count' => 0,
        'searchterm' => NULL,
      ),
    ),
    'islandora_digital_workflow_batch_records_table' => array(
      'template' => 'theme/islandora-digital-workflow-batch-records-table',
      'variables' => array(
        'batch_records' => array(),
        'table_title' => '',
        'table_description' => '',
      ),
    ),
  );
}

function gamera_pitt_field__field_stage__workflow_batch($context) {
  $value = (array_key_exists('element', $context) && array_key_exists('#items', $context['element']) && array_key_exists('tid', $context['element']['#items'][0])) ?
    $context['element']['#items'][0]['tid'] : 0;
  if ($value) {
    module_load_include('module', 'taxonomy', 'taxonomy');
    $term = taxonomy_term_load($value);
    $term_link = l($term->name, 'taxonomy/term/' . $value);
    $stage_str = array('New', 'Scanned', 'Problem', 'Reviewed', 'Done');
    return '<div class="field field-type-user-reference field-label-inline">' .
           '<div class="stage_block stage_' . $term->name . '">' . $term_link . '</div>' . // $stage_str[$value]
           '<br style="clear:both">' .
           '</div>';
  }
}

/**
 * Hook for hook_node_update.
 *
 * To display all of the related islandora_digital_workflow_batch1 record's
 * values on the Node page, this code will update the field_batch_defaults
 * field with the values from the batch record so that all of those do not
 * need to be CCK fields.
 */
function islandora_digital_workflow_node_update($node) {
  global $system_creating_nodes;
  if (!$system_creating_nodes) {
    module_load_include('inc', 'islandora_digital_workflow', 'includes/node-utilities');
    islandora_digital_workflow_sync_node_batch_record_info($node, array(), '', FALSE);
  }
}

